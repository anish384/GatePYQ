<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images/logo_iit_madras_without_background.png" type="image/x-icon">
    <title>GATE Exam Interface</title>
    <link rel="stylesheet" href="css/exam_style.css">
    <!-- <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']]
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            },
            chtml: {
                scale: 1.9 // 1.0 is 100%. 1.2 scales it up by 20%.
            },
            svg: {
                scale: 1.9 // Add this instead if you are using the SVG output renderer
            }
        };
    </script> -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['\\(', '\\)']], displayMath: [['\\[', '\\]']] },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], enableMenu: false },
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    <!-- <script defer src="https://cdn.jsdelivr.net/npm/mathjax@4.0.0/tex-mml-chtml.js" async></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Upload Section -->
    <div id="uploadSection" class="upload-section">
        <div class="bookmarks-quick-link" style="text-align:center; margin-top:15px;">
            <a href="analytics.html"
                style="color:#3498db; font-weight:600; font-size:15px; text-decoration:none; display:inline-flex; align-items:center; gap:6px;">
                üìä Analytics Dashboard
            </a>
            <span style="color:#666; margin:0 10px;">|</span>
            <a href="bookmarks.html"
                style="color:#1abc9c; font-weight:600; font-size:15px; text-decoration:none; display:inline-flex; align-items:center; gap:6px;">
                üìå Bookmarks
            </a>
            <span style="color:#666; margin:0 10px;">|</span>
            <a href="silly_mistakes.html"
                style="color:#e67e22; font-weight:600; font-size:15px; text-decoration:none; display:inline-flex; align-items:center; gap:6px;">
                ü§¶ Silly Mistakes
            </a>
            <span style="color:#666; margin:0 10px;">|</span>
            <a href="exam_library.html"
                style="color:#8e44ad; font-weight:600; font-size:15px; text-decoration:none; display:inline-flex; align-items:center; gap:6px;">
                üìö Exam Library
            </a>
        </div>

        <div class="data-management" style="text-align:center; margin-top:10px; margin-bottom: 15px;">
            <button id="exportDataBtn" onclick="handleExportData()"
                style="background:none; border:none; color:#3498db; cursor:pointer; font-size:14px; text-decoration:underline;">üì•
                Backup All Data</button>

            <span style="color:#666; margin:0 10px;">|</span>

            <button id="importDataBtn" onclick="document.getElementById('importFileInput').click()"
                style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:14px; text-decoration:underline;">üì§
                Restore Data</button>
            <input type="file" id="importFileInput" style="display:none;" accept=".json"
                onchange="handleImportData(event)">

            <span style="color:#666; margin:0 10px;">|</span>

            <button id="tgSetupBtn" onclick="openTgSetupModal()"
                style="background:none; border:none; color:#9b59b6; cursor:pointer; font-size:14px; text-decoration:underline; display:inline-flex; align-items:center; gap:4px;">
                ü§ñ Telegram Backup
            </button>

            <span style="color:#666; margin:0 10px;">|</span>

            <span id="storageUsageContainer"
                style="font-size:14px; color:#666; display:inline-flex; align-items:center; gap:4px;">
                üíæ <span id="storageUsageValue">Loading...</span>
            </span>

            <span style="color:#666; margin:0 10px;">|</span>

            <a href="support.html"
                style="background:none; border:none; color:#f39c12; cursor:pointer; font-size:14px; text-decoration:underline; display:inline-block;">‚òï
                Buy me a coffee</a>
        </div>
        <button class="dark-mode-toggle standalone" id="uploadDarkToggle" title="Toggle Dark Mode">
            <span class="icon-moon">üåô</span>
            <span class="icon-sun">‚òÄÔ∏è</span>
        </button>
        <div class="home-layout-container">
            <!-- Left Sidebar -->
            <div class="home-sidebar">
                <div class="streak-tracker stat-card"
                    style="background: rgba(26, 188, 156, 0.1); border: 1px solid rgba(26, 188, 156, 0.3); padding: 18px 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                    <div
                        style="font-size: 13px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        üî• Daily Streak</div>
                    <div style="font-size: 24px; font-weight: bold; color: #1abc9c; margin-top: 5px;"
                        id="streakCountDisplay">0 Days</div>
                    <div id="streakCalendarContainer"></div>
                </div>

            </div>

            <!-- Main Content -->
            <div class="home-main-content">
                <div class="upload-card">
                    <h1 class="upload-title">GATE Exam Interface</h1>
                    <p class="upload-subtitle">Upload your exam JSON file to begin</p>

                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" class="file-input" accept=".json">
                        <label for="fileInput" class="file-label">Choose JSON File</label>
                        <div id="fileName" class="file-name">No file selected</div>
                    </div>

                    <button id="startExam" class="btn-start" disabled>Start Exam</button>

                    <!-- Custom Exam Builder Div -->
                    <div class="custom-exam-builder"
                        style="margin-top: 30px; padding-top: 25px; border-top: 1px dashed rgba(0,0,0,0.1);">
                        <h3 style="margin-top: 0; margin-bottom: 5px; font-size: 18px; color: var(--text-color);">üõ†Ô∏è
                            Custom Practice Exam</h3>
                        <p style="font-size: 13px; color: #888; margin-bottom: 15px;">Generate a mixed exam from your
                            saved questions.</p>

                        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                            <div style="flex: 1; text-align: left;">
                                <label
                                    style="display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: var(--text-color);">From
                                    Bookmarks üìå</label>
                                <input type="number" id="customBkqInput" min="0" max="50" value="5"
                                    class="custom-num-input">
                                <small class="avail-text" id="availBkq">Avail: 0</small>
                            </div>
                            <div style="flex: 1; text-align: left;">
                                <label
                                    style="display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: var(--text-color);">From
                                    Mistakes ü§¶</label>
                                <input type="number" id="customSmInput" min="0" max="50" value="5"
                                    class="custom-num-input">
                                <small class="avail-text" id="availSm">Avail: 0</small>
                            </div>
                        </div>

                        <button id="startCustomExamBtn" class="btn-start custom-exam-btn">
                            Start Custom Exam ‚ú®
                        </button>
                    </div>

                    <div id="unfinishedExamActions" class="unfinished-actions" style="display:none; margin-top: 20px;">
                        <p class="unfinished-text">You have an unfinished exam in progress.</p>
                        <div class="unfinished-btns">
                            <button id="resumeExam" class="btn-resume">Resume Exam</button>
                            <button id="discardExam" class="btn-discard">Discard & Start New</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="home-sidebar">
                <div class="gate-countdown stat-card"
                    style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); padding: 18px 15px; border-radius: 8px; text-align: center;">
                    <div
                        style="font-size: 13px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        ‚è≥ GATE 2027 In</div>
                    <div style="font-size: 20px; font-weight: bold; color: #3498db; margin-top: 5px; margin-bottom: 10px; font-variant-numeric: tabular-nums;"
                        id="gateCountdownDisplay">Loading...</div>
                    <div id="gateCalendarContainer"></div>
                </div>
            </div>
        </div>

        <!-- Test History Section (Moved out of layout container for full width) -->
        <div id="historySection" class="history-section"
            style="display: none; width: 100%; max-width: 1200px; margin: 30px auto 0;">
            <h2 class="history-title">üìã Test History</h2>

            <!-- Progress Over Time Chart -->
            <div
                style="margin-bottom: 25px; padding: 15px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                <canvas id="historyProgressChart" style="height: 250px; width: 100%;"></canvas>
            </div>

            <div class="history-controls">
                <input type="text" id="historySearch" placeholder="Search exams by title..." class="history-search"
                    oninput="renderHistoryTable()">
                <select id="historySort" class="history-sort" onchange="renderHistoryTable()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="score_high">Highest Score</option>
                    <option value="score_low">Lowest Score</option>
                </select>
            </div>
            <div class="history-table-wrapper">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Exam Title</th>
                            <th>Date</th>
                            <th>Percentage</th>
                            <th>Marks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div> <!-- End of uploadSection -->

    <!-- Exam Section -->
    <div id="examSection" class="exam-container" style="display: none;">

        <!-- Top Header - GATE Branding -->
        <div class="top-header">
            <div class="logo-area">
                <div class="gate-logo-circle"><img src="images/logo_iit_madras_without_background.png" alt="logo">
                </div>
            </div>
            <div class="header-title-area">
                <div class="exam-center-name">GRADUATE APTITUDE TEST IN ENGINEERING (GATE 2027)</div>
                <div class="organizing-institute"> INDIAN INSTITUTE OF TECHNOLOGY MADRAS
                </div>
            </div>
            <div class="header-right-logos">
                <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode">
                    <span class="icon-moon">üåô</span>
                    <span class="icon-sun">‚òÄÔ∏è</span>
                </button>
                <div class="gate-logo-circle"><img src="images/bombayTheGoal.png" alt="The Goal"></div>
            </div>
        </div>

        <!-- Sub Header - Exam Title Bar (Dark Teal) -->
        <div class="sub-header">
            <div class="subject-title" id="examTitle">GATE Exam</div>
            <div class="right-tools">
                <a href="#" class="header-link"><span class="link-icon">&#9432;</span> Instructions</a>
                <a href="#" class="header-link" id="viewQuestionPaperBtn"><span class="link-icon">&#128196;</span>
                    Question Paper</a>
            </div>
        </div>

        <!-- Info Bar with Section Pill + Profile Name -->
        <div class="info-bar">
            <div class="info-bar-left">
                <span class="nav-arrow">&lsaquo;</span>
                <span class="section-pill" id="currentSectionPill">Section</span>
                <span class="nav-arrow">&rsaquo;</span>
            </div>
            <div class="info-bar-right">
                <span class="candidate-name-top" id="candidateName">AIR 1</span>
            </div>
        </div>

        <!-- Section Tabs Bar -->
        <div class="section-tabs-bar">
            <div class="sections-label">Sections</div>
            <div class="tabs-container" id="sectionTabs">
                <!-- Tabs will be loaded here -->
            </div>
            <div class="tabs-nav-arrow">&rsaquo;</div>
            <!-- <div class="question-timer-container">
                <span class="question-timer-label">Q. Time :</span>
                <div class="question-timer-display" id="questionTimerDisplay">00:00</div>
            </div> -->
            <div class="question-number-bar">
                <button class="calc-icon-btn" id="calculatorBtn" title="Virtual Calculator">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="#3a9bd9">
                        <rect x="2" y="2" width="20" height="20" rx="3" fill="#3a9bd9" />
                        <rect x="5" y="4" width="14" height="5" rx="1" fill="#fff" />
                        <rect x="5" y="11" width="3" height="3" rx="0.5" fill="#fff" />
                        <rect x="10.5" y="11" width="3" height="3" rx="0.5" fill="#fff" />
                        <rect x="16" y="11" width="3" height="3" rx="0.5" fill="#fff" />
                        <rect x="5" y="16" width="3" height="3" rx="0.5" fill="#fff" />
                        <rect x="10.5" y="16" width="3" height="3" rx="0.5" fill="#fff" />
                        <rect x="16" y="16" width="3" height="3" rx="0.5" fill="#fff" />
                    </svg>
                </button>
            </div>
            <div class="timer-container">
                <span class="time-left-label">Time Left :</span>
                <div class="timer-display" id="timeDisplay">00:00:00</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="exam-content">
            <!-- Question Area -->
            <div class="question-area">
                <!-- Question Type & Marks bar -->
                <div class="question-header-bar">
                    <span class="q-type">Question Type: <span id="questionType">MCQ</span></span>
                    <span class="q-marks-info" id="questionMarks">Marks for correct answer: 1 | Negative Marks:
                        0.33</span>
                </div>

                <!-- Question Number & Calculator Icon -->
                <div class="question-number-bar">
                    <span class="q-no">Question No. <span id="questionNumber">1</span></span>
                </div>

                <!-- Question Text -->
                <div class="question-text" id="questionText">
                    Loading question...
                </div>

                <!-- Options -->
                <div class="options-container" id="optionsContainer">
                    <!-- Options loaded here -->
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Profile -->
                <div class="profile-section">
                    <div class="profile-pic-wrapper">
                        <img src="images/profile_photo_without_background.png" alt="Profile" class="my-photo">
                    </div>
                    <div class="profile-details">
                        <div id="candidateNameSidebar">AIR 1</div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="legend-section">
                    <div class="legend-grid">
                        <div class="legend-item">
                            <div class="legend-icon lg-answered" id="legendAnswered">0</div>
                            <span>Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-icon lg-not-answered" id="legendNotAnswered">0</div>
                            <span>Not Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-icon lg-not-visited" id="legendNotVisited">0</div>
                            <span>Not Visited</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-icon lg-marked" id="legendMarked">0</div>
                            <span>Marked for Review</span>
                        </div>
                        <div class="legend-item legend-item-full">
                            <div class="legend-icon lg-marked-answered" id="legendMarkedAnswered">0</div>
                            <span>Answered & Marked for Review (will also be evaluated)</span>
                        </div>
                    </div>
                </div>

                <!-- Palette Header -->
                <div class="palette-header" id="paletteHeader">
                    Section
                </div>
                <div class="palette-sub-header">Choose a Question</div>

                <!-- Question Palette -->
                <div class="palette-container" id="questionPalette">
                    <!-- Palette loaded here -->
                </div>
            </div>
        </div>

        <!-- FULL WIDTH Bottom Action Bar -->
        <div class="bottom-action-bar">
            <div class="bottom-left-btns">
                <button class="btn btn-action-default" id="markReview">Mark for Review & Next</button>
                <button class="btn btn-action-default" id="clearResponse">Clear Response</button>
            </div>
            <div class="bottom-center-btns">
                <button class="btn btn-action-default" id="previousBtn">Previous</button>
                <button class="btn btn-save-next" id="saveNext">Save & Next</button>
            </div>
            <div class="bottom-submit-btn">
                <button class="btn btn-submit-main" id="submitBtn">Submit</button>
            </div>
        </div>

        <!-- Version Footer -->
        <div class="version-footer">
            Version : 17.07.00
        </div>
    </div>

    <!-- Submit Confirmation Modal -->
    <div id="submitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Submit Confirmation</div>
            <p>Are you sure you want to submit the test?</p>

            <div class="summary-grid" id="summaryGrid">
            </div>

            <div class="modal-buttons">
                <button class="btn btn-cancel" id="cancelSubmit">Cancel</button>
                <button class="btn btn-confirm" id="confirmSubmit">Submit</button>
            </div>
        </div>
    </div>

    <!-- Telegram Setup Wizard Modal -->
    <div id="tgSetupModal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: left;">
            <div class="modal-header" style="justify-content: space-between; display: flex;">
                Telegram Auto-Backup Setup
                <button onclick="closeTgSetupModal()"
                    style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>

            <div id="tgStep1" class="tg-step">
                <h3 style="margin-top:0;">Step 1: Get Bot Token</h3>
                <p>1. Open Telegram and search for <strong>@BotFather</strong>.</p>
                <p>2. Send <code>/newbot</code> and follow instructions to create a bot.</p>
                <p>3. Copy the HTTP API Token provided.</p>
                <div style="margin-top: 15px;">
                    <label style="display:block; margin-bottom: 5px; font-weight: bold;">Bot Token:</label>
                    <input type="text" id="tgInputToken" placeholder="e.g. 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz"
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace;">
                </div>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button class="btn btn-confirm" onclick="nextTgStep(2)">Next Step</button>
                </div>
            </div>

            <div id="tgStep2" class="tg-step" style="display: none;">
                <h3 style="margin-top:0;">Step 2: Create a Private Channel</h3>
                <p>1. In Telegram, create a new <strong>Channel</strong>.</p>
                <p>2. Set the channel type to <strong>Private</strong>.</p>
                <p>3. Add your newly created bot to the channel as an <strong>Administrator</strong> (it needs
                    permission to Post Messages).</p>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button class="btn btn-cancel" onclick="nextTgStep(1)">Back</button>
                    <button class="btn btn-confirm" onclick="nextTgStep(3)">Next Step</button>
                </div>
            </div>

            <div id="tgStep3" class="tg-step" style="display: none;">
                <h3 style="margin-top:0;">Step 3: Get Channel ID</h3>
                <p>1. Open <a href="https://web.telegram.org/" target="_blank" style="color: #3498db;">Telegram Web</a>
                    in your browser and log in.</p>
                <p>2. Open the Private Channel you just created.</p>
                <p>3. Look at the URL in your browser. It will look something like
                    this:<br><code>https://web.telegram.org/a/#-1001234567890</code> or <code>.../#1234567890</code></p>
                <p>4. Extract the number part: <strong>1234567890</strong>.</p>
                <div style="margin-top: 15px;">
                    <label style="display:block; margin-bottom: 5px; font-weight: bold;">Channel ID:</label>
                    <input type="text" id="tgInputChatId" placeholder="e.g. 1234567890 or -1001234567890"
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace;">
                </div>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button class="btn btn-cancel" onclick="nextTgStep(2)">Back</button>
                    <button class="btn btn-confirm" onclick="nextTgStep(4)">Next Step</button>
                </div>
            </div>

            <div id="tgStep4" class="tg-step" style="display: none;">
                <h3 style="margin-top:0;">Step 4: Final Verification</h3>
                <p>Please confirm your details. We will automatically add the required <code>-100</code> prefix to the
                    Channel ID if it's missing.</p>
                <div
                    style="background: var(--card-bg, #f9f9f9); padding: 10px; border-radius: 4px; margin-top: 10px; border: 1px solid #ddd;">
                    <strong>Token:</strong> <span id="tgVerifyToken"
                        style="font-family: monospace; word-break: break-all;"></span><br><br>
                    <strong>Channel ID:</strong> <span id="tgVerifyChatId" style="font-family: monospace;"></span>
                </div>
                <p style="font-size: 13px; color: #666; margin-top: 15px;">Note: These credentials will be stored
                    locally in your browser.</p>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button class="btn btn-cancel" onclick="nextTgStep(3)">Back</button>
                    <button class="btn btn-confirm" onclick="saveTgSetup()">Save & Enable Backup</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        async function handleExportData() {
            if (confirm("This will download a full backup of all your exams, bookmarks, and silly mistakes. Proceed?")) {
                const success = await downloadBackup();
                if (success) alert("Backup downloaded successfully!");
                else alert("Failed to backup data.");
            }
        }

        async function handleImportData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (confirm("WARNING: Restoring data will OVERWRITE and REPLACE all your current exams, bookmarks, and silly mistakes with the data from the backup file. Are you sure you want to proceed?")) {
                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        await importAllData(jsonData);
                        alert("Data restored successfully! The page will now reload.");
                        location.reload();
                    } catch (error) {
                        alert("Error restoring data: " + error.message);
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            }
            // Reset input
            event.target.value = '';
        }


        function copyPromptText(btn) {
            const pre = btn.closest('.pre-wrapper').querySelector('pre');
            const text = pre.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const span = btn.querySelector('span');
                const originalText = span.textContent;
                span.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    span.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // ============================================
        // Telegram Setup Wizard Logic
        // ============================================
        function openTgSetupModal() {
            document.getElementById('tgInputToken').value = localStorage.getItem('tgBotToken') || '';
            document.getElementById('tgInputChatId').value = localStorage.getItem('tgChatId') || '';

            document.getElementById('tgSetupModal').classList.add('active');
            nextTgStep(1);
        }

        function closeTgSetupModal() {
            document.getElementById('tgSetupModal').classList.remove('active');
        }

        function nextTgStep(stepNum) {
            if (stepNum === 2) {
                const token = document.getElementById('tgInputToken').value.trim();
                if (!token) {
                    alert("Please enter your bot token to proceed.");
                    return;
                }
            } else if (stepNum === 4) {
                const chatIdRaw = document.getElementById('tgInputChatId').value.trim();
                if (!chatIdRaw) {
                    alert("Please enter your Channel ID to proceed.");
                    return;
                }

                // Format chat ID
                let formattedChatId = chatIdRaw;
                // If it's a positive number or doesn't start with -100, we probably need to prepend -100 for Telegram Channels
                if (!formattedChatId.startsWith('-100') && !formattedChatId.startsWith('@')) {
                    // Remove any existing minus sign just in case
                    formattedChatId = '-100' + formattedChatId.replace(/^-/, '');
                }

                document.getElementById('tgVerifyToken').textContent = document.getElementById('tgInputToken').value.trim();
                document.getElementById('tgVerifyChatId').textContent = formattedChatId;
            }

            document.querySelectorAll('.tg-step').forEach(el => el.style.display = 'none');
            document.getElementById('tgStep' + stepNum).style.display = 'block';
        }

        function saveTgSetup() {
            const token = document.getElementById('tgInputToken').value.trim();
            let chatId = document.getElementById('tgVerifyChatId').textContent;

            localStorage.setItem('tgBotToken', token);
            localStorage.setItem('tgChatId', chatId);

            closeTgSetupModal();
            alert("Telegram settings saved successfully! We will attempt a backup now.");
            autoBackupToTelegram(true); // Force backup attempt
        }
    </script>

    <script src="js/db.js"></script>
    <script src="js/exam_script.js"></script>
    <script>
        // Load test history on page load
        (async function () {
            try {
                // Security cleanup: Remove hardcoded token if present from previous versions
                if (localStorage.getItem('tgBotToken') === '8710067572:AAEu-qO_BjWw-8ZHP_uJN-LbPwc4oWQFpY0') {
                    localStorage.removeItem('tgBotToken');
                    localStorage.removeItem('tgChatId');
                }

                await initDB();
                loadHistory();
                initHomeFeatures();

                // Trigger auto-backup check
                autoBackupToTelegram();
                initTodos();
                loadStorageUsage();
            } catch (e) {
                console.warn('Could not load history or trigger backup:', e);
            }
        })();

        // Load and display storage usage
        async function loadStorageUsage() {
            try {
                const usage = await getStorageUsage();
                const el = document.getElementById('storageUsageValue');
                if (el) {
                    el.textContent = formatStorageSize(usage.used) + ' used';
                    // Color code based on size
                    const parent = el.parentElement;
                    if (usage.used > 500 * 1024 * 1024) parent.style.color = '#e74c3c'; // > 500MB: red
                    else if (usage.used > 100 * 1024 * 1024) parent.style.color = '#e67e22'; // > 100MB: orange
                    else parent.style.color = '#27ae60'; // green
                }
            } catch (e) {
                console.warn('Could not load storage usage:', e);
            }
        }

        // ============================================
        // Auto-Backup to Telegram
        // ============================================
        let isBackingUp = false;
        async function autoBackupToTelegram(force = false) {
            if (isBackingUp) return;

            const token = localStorage.getItem('tgBotToken');
            const chatId = localStorage.getItem('tgChatId');

            // Only proceed if setup is complete
            if (!token || !chatId) {
                if (force) alert("Please complete the Telegram Backup Setup first.");
                return;
            }

            const lastBackupStr = localStorage.getItem('lastTgBackupTime');
            const now = Date.now();

            // Auto backup once every 24 hours unless forced
            const ONE_DAY = 24 * 60 * 60 * 1000;
            if (!force && lastBackupStr && (now - parseInt(lastBackupStr)) < ONE_DAY) {
                return;
            }

            try {
                isBackingUp = true;

                const blob = await generateBackupBlob();
                const dateStr = new Date().toISOString().split('T')[0];
                const fileName = `GATE_Exam_Backup_${dateStr}.json`;
                const file = new File([blob], fileName, { type: 'application/json' });

                const formData = new FormData();
                formData.append('chat_id', chatId);
                formData.append('document', file);
                formData.append('caption', `üì¶ GATE Prep DB Backup\nüìÖ ${new Date().toLocaleString()}`);

                const url = `https://api.telegram.org/bot${token}/sendDocument`;

                // Fire and forget mostly, but catch errors
                fetch(url, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.ok) {
                            localStorage.setItem('lastTgBackupTime', now.toString());
                            if (force) alert("Backup successfully sent to Telegram!");
                        } else {
                            console.error("Telegram API Error:", data);
                            if (force) alert("Failed to send backup to Telegram: " + data.description);
                        }
                    })
                    .catch(err => {
                        console.error("Fetch Error:", err);
                        if (force) alert("Network error while sending backup to Telegram.");
                    })
                    .finally(() => {
                        isBackingUp = false;
                    });

            } catch (e) {
                console.error("Error generating backup for Telegram:", e);
                isBackingUp = false;
                if (force) alert("Error generating backup file.");
            }
        }

        let allExams = [];

        async function loadHistory() {
            allExams = await getExamHistory();
            renderHistoryTable();
        }

        // Global variable to track the currently selected date for the To-Do list
        // Defaults to today's date in YYYY-MM-DD format
        let currentTodoDate = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(new Date().getDate()).padStart(2, '0')}`;

        // Initialize To-Dos
        async function initTodos() {
            try {
                await initDB();
                await renderTodoList();

                document.getElementById('addTodoBtn').addEventListener('click', handleAddTodo);
                document.getElementById('todoInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleAddTodo();
                });
            } catch (e) {
                console.warn('Could not load To-Dos:', e);
            }
        }

        // Expose function for the Streak Calendar to call when a date is clicked
        window.selectTodoDate = async function (dateStr) {
            currentTodoDate = dateStr;

            // Format for display
            const d = new Date(dateStr);
            const displayTitle = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

            // If today, label it "Daily Notes", else specific date
            const todayStr = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(new Date().getDate()).padStart(2, '0')}`;
            const headerLabel = document.getElementById('todoHeaderLabel');
            if (dateStr === todayStr) {
                headerLabel.textContent = "üìù Daily Notes";
            } else {
                headerLabel.textContent = `üìù Notes: ${displayTitle}`;
            }

            // Animate refresh
            const listEl = document.getElementById('todoList');
            if (listEl) {
                listEl.style.opacity = '0.5';
                await renderTodoList();
                listEl.style.opacity = '1';
            }
        };

        async function renderTodoList() {
            const listEl = document.getElementById('todoList');
            if (!listEl) return;

            try {
                // Now fetching strictly by target date
                const todos = await getTodosByDate(currentTodoDate);

                if (todos.length === 0) {
                    listEl.innerHTML = '<div class="todo-empty-state">No notes for today. Add one above!</div>';
                    return;
                }

                todos.sort((a, b) => new Date(a.dateCreated) - new Date(b.dateCreated));

                listEl.innerHTML = todos.map(todo => `
                    <li class="todo-item ${todo.completed ? 'completed' : ''}" data-id="${todo.id}">
                        <div class="todo-content">
                            <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} onchange="handleToggleTodo(${todo.id}, this.checked)">
                            <span class="todo-text">${escapeHtml(todo.text)}</span>
                        </div>
                        <button class="todo-delete-btn" onclick="handleDeleteTodo(${todo.id})" title="Delete">&#10005;</button>
                    </li>
                `).join('');

            } catch (e) {
                console.error("Error rendering todos:", e);
                listEl.innerHTML = '<div class="todo-empty-state" style="color:#e74c3c;">Failed to load notes.</div>';
            }
        }

        async function handleAddTodo() {
            const input = document.getElementById('todoInput');
            const text = input.value.trim();
            if (!text) return;

            try {
                input.value = '';
                await saveTodoToDB(text, currentTodoDate);
                await renderTodoList();
                // Refresh calendar to show the dot marker if this was the first task
                if (typeof loadCalendar === 'function') loadCalendar();
            } catch (e) {
                console.error("Error adding todo:", e);
            }
        }

        window.handleToggleTodo = async function (id, completed) {
            try {
                await toggleTodoInDB(id, completed);
                await renderTodoList();
            } catch (e) {
                console.error("Error toggling todo:", e);
            }
        };

        window.handleDeleteTodo = async function (id) {
            try {
                await removeTodoFromDB(id);
                await renderTodoList();
                // Refresh calendar to potentially remove the dot marker
                if (typeof loadCalendar === 'function') loadCalendar();
            } catch (e) {
                console.error("Error deleting todo:", e);
            }
        };

        function escapeHtml(unsafe) {
            return (unsafe || '').toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderHistoryTable() {
            const section = document.getElementById('historySection');
            const tbody = document.getElementById('historyBody');

            if (allExams.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            const searchInput = document.getElementById('historySearch');
            const sortSelect = document.getElementById('historySort');

            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const sortBy = sortSelect ? sortSelect.value : 'newest';

            let filtered = allExams.filter(exam => exam.title.toLowerCase().includes(searchTerm));

            filtered.sort((a, b) => {
                if (sortBy === 'newest') return new Date(b.date) - new Date(a.date);
                if (sortBy === 'oldest') return new Date(a.date) - new Date(b.date);

                // Use the exact same percentage formula as the display table
                const scoreA = parseFloat(a.max_marks) > 0 ? (parseFloat(a.total_marks) / parseFloat(a.max_marks)) * 100 : 0;
                const scoreB = parseFloat(b.max_marks) > 0 ? (parseFloat(b.total_marks) / parseFloat(b.max_marks)) * 100 : 0;

                if (sortBy === 'score_high') return scoreB - scoreA;
                if (sortBy === 'score_low') return scoreA - scoreB;

                return 0;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">No matching exams found.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map((exam, i) => {
                const date = new Date(exam.date).toLocaleDateString('en-IN', {
                    day: '2-digit', month: 'short', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                const percentage = parseFloat(exam.max_marks) > 0
                    ? ((parseFloat(exam.total_marks) / parseFloat(exam.max_marks)) * 100).toFixed(2)
                    : '0.00';

                let scoreText = `${percentage}%`;
                if (isNaN(percentage)) scoreText = '0.00%';

                const marks = `${parseFloat(exam.total_marks).toFixed(2)}/${exam.max_marks}`;
                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td class="hist-title">${exam.title}</td>
                        <td>${date}</td>
                        <td><span class="hist-score">${scoreText}</span></td>
                        <td><span class="hist-marks">${marks}</span></td>
                        <td class="hist-actions">
                            <button class="btn-hist btn-view" onclick="viewExam(${exam.id})">View</button>
                            <button class="btn-hist btn-delete" onclick="deleteExamEntry(${exam.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Render Chart
            renderHistoryChart(filtered);
        }

        function renderHistoryChart(exams) {
            const ctx = document.getElementById('historyProgressChart');
            if (!ctx || exams.length === 0) return;

            if (window.historyChart) {
                window.historyChart.destroy();
            }

            // We need to sort chronologically for the chart, even if the table is sorted differently
            const chronologicalExams = [...exams].sort((a, b) => new Date(a.date) - new Date(b.date));
            const recentExams = chronologicalExams.slice(-20); // Show up to last 20 for readability

            const labels = recentExams.map(e => {
                const d = new Date(e.date);
                return `${d.getDate()}/${d.getMonth() + 1}`;
            });

            const dataPoints = recentExams.map(e =>
                parseFloat(e.max_marks) > 0 ? ((parseFloat(e.total_marks) / parseFloat(e.max_marks)) * 100).toFixed(1) : 0
            );

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#d8d8e4' : '#333';
            const gridColor = isDark ? '#333' : '#ddd';

            window.historyChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score %',
                        data: dataPoints,
                        borderColor: '#95a5a6',
                        backgroundColor: 'rgba(149, 165, 166, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#7f8c8d',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `Score: ${ctx.parsed.y}%`
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // Daily Streak & GATE Countdown Logic
        // ============================================
        function initHomeFeatures() {
            // 1. GATE 2027 Countdown (Target: Feb 1, 2027)
            const targetDate = new Date("2027-02-01T00:00:00").getTime();
            const countdownEl = document.getElementById('gateCountdownDisplay');

            function updateCountdown() {
                const now = new Date().getTime();
                const diff = targetDate - now;

                if (diff <= 0) {
                    countdownEl.textContent = "It's Exam Day!";
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                countdownEl.textContent = `${days}d ${hours}h`;
            }

            updateCountdown();
            setInterval(updateCountdown, 1000 * 60 * 60); // Update every hour is enough for "days + hours"

            // 2. GATE 2027 Calendar Logic
            function loadGateCalendar() {
                const container = document.getElementById('gateCalendarContainer');
                if (!container) return;

                // Set to the 1st of the month immediately to prevent the 31st-to-30th rollover bug
                let currentGateCalDate = new Date();
                currentGateCalDate.setDate(1);

                // Use Event Delegation: Attach ONE event listener to the container
                container.addEventListener('click', (e) => {
                    if (e.target.id === 'gateCalPrevBtn') {
                        currentGateCalDate.setMonth(currentGateCalDate.getMonth() - 1);
                        renderGateCalendar(currentGateCalDate);
                    } else if (e.target.id === 'gateCalNextBtn') {
                        currentGateCalDate.setMonth(currentGateCalDate.getMonth() + 1);
                        renderGateCalendar(currentGateCalDate);
                    }
                });

                function renderGateCalendar(dateObj) {
                    const year = dateObj.getFullYear();
                    const month = dateObj.getMonth();

                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    // Calculate "today" variables ONCE outside the loop
                    const today = new Date();
                    const todayYear = today.getFullYear();
                    const todayMonth = today.getMonth();
                    const todayDate = today.getDate();

                    // Midnight today for easy past/future comparison
                    const todayMidnightTime = new Date(todayYear, todayMonth, todayDate).getTime();

                    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

                    let html = `
            <div class="calendar-nav">
                <button class="cal-nav-btn" id="gateCalPrevBtn">&lt;</button>
                <span style="font-size: 14px;">${monthNames[month]} ${year}</span>
                <button class="cal-nav-btn" id="gateCalNextBtn">&gt;</button>
            </div>
            <div class="streak-calendar">
                <div class="calendar-header-day">S</div>
                <div class="calendar-header-day">M</div>
                <div class="calendar-header-day">T</div>
                <div class="calendar-header-day">W</div>
                <div class="calendar-header-day">T</div>
                <div class="calendar-header-day">F</div>
                <div class="calendar-header-day">S</div>
        `;

                    // Empty slots
                    for (let i = 0; i < firstDay; i++) {
                        html += `<div></div>`;
                    }

                    // Days loop
                    for (let day = 1; day <= daysInMonth; day++) {
                        const currentIterTime = new Date(year, month, day).getTime();

                        // Simple integer comparison is faster than string building
                        const isToday = (year === todayYear && month === todayMonth && day === todayDate);
                        const isPast = currentIterTime < todayMidnightTime;

                        let classes = 'calendar-day';
                        if (isToday) classes += ' today';
                        if (isPast) classes += ' crossed-out';

                        html += `<div class="${classes}">${day}</div>`;
                    }

                    html += `</div>`;
                    container.innerHTML = html;
                }

                renderGateCalendar(currentGateCalDate);
            }

            loadGateCalendar();

            // // 2. GATE 2027 Calendar Logic
            // function loadGateCalendar() {
            //     let currentGateCalDate = new Date(); // Start with current month

            //     function renderGateCalendar(dateObj) {
            //         const container = document.getElementById('gateCalendarContainer');
            //         if (!container) return;

            //         const year = dateObj.getFullYear();
            //         const month = dateObj.getMonth();

            //         const firstDay = new Date(year, month, 1).getDay();
            //         const daysInMonth = new Date(year, month + 1, 0).getDate();
            //         const today = new Date();
            //         const todayDateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            //         const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            //         let html = `
            //                 <div class="calendar-nav">
            //                     <button class="cal-nav-btn" id="gateCalPrevBtn">&lt;</button>
            //                     <span style="font-size: 14px;">${monthNames[month]} ${year}</span>
            //                     <button class="cal-nav-btn" id="gateCalNextBtn">&gt;</button>
            //                 </div>
            //                 <div class="streak-calendar">
            //                     <div class="calendar-header-day">S</div>
            //                     <div class="calendar-header-day">M</div>
            //                     <div class="calendar-header-day">T</div>
            //                     <div class="calendar-header-day">W</div>
            //                     <div class="calendar-header-day">T</div>
            //                     <div class="calendar-header-day">F</div>
            //                     <div class="calendar-header-day">S</div>
            //             `;

            //         // Empty slots
            //         for (let i = 0; i < firstDay; i++) {
            //             html += `<div></div>`;
            //         }

            //         for (let day = 1; day <= daysInMonth; day++) {
            //             const currentIterDate = new Date(year, month, day);
            //             const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            //             const isToday = (dateStr === todayDateStr);

            //             // Check if the day has passed (ignoring time)
            //             const isPast = currentIterDate < new Date(today.getFullYear(), today.getMonth(), today.getDate());

            //             let classes = 'calendar-day';
            //             if (isToday) classes += ' today';
            //             if (isPast) classes += ' crossed-out';

            //             html += `<div class="${classes}">${day}</div>`;
            //         }

            //         html += `</div>`;
            //         container.innerHTML = html;

            //         document.getElementById('gateCalPrevBtn').addEventListener('click', () => {
            //             currentGateCalDate.setMonth(currentGateCalDate.getMonth() - 1);
            //             renderGateCalendar(currentGateCalDate);
            //         });

            //         document.getElementById('gateCalNextBtn').addEventListener('click', () => {
            //             currentGateCalDate.setMonth(currentGateCalDate.getMonth() + 1);
            //             renderGateCalendar(currentGateCalDate);
            //         });
            //     }

            //     renderGateCalendar(currentGateCalDate);
            // }

            // loadGateCalendar();

            // 3. Daily Streak Logic
            const streakEl = document.getElementById('streakCountDisplay');

            // Calendar Rendering & Streak logic
            async function loadCalendar() {
                try {
                    await initDB();
                    const history = await getExamHistory();

                    // Collect all unique dates in YYYY-MM-DD local format for active streak days
                    const activeDates = new Set();
                    history.forEach(ex => {
                        if (ex.date) {
                            const d = new Date(ex.date);
                            const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                            activeDates.add(dateStr);
                        }
                    });

                    // Collect all unique dates that have To-Dos
                    const allTodos = await getAllTodos();
                    const todoDates = new Set();
                    allTodos.forEach(todo => {
                        if (todo.targetDate) {
                            todoDates.add(todo.targetDate);
                        }
                    });

                    // Calculate Current Streak
                    let calculatedStreak = 0;
                    const today = new Date();

                    // Start checking from today backwards
                    let checkDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                    while (true) {
                        const dateStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;

                        // If today is not in activeDates, but yesterday is, streak still counts (haven't played today yet)
                        if (calculatedStreak === 0 && !activeDates.has(dateStr)) {
                            // It's today, we check yesterday
                            checkDate.setDate(checkDate.getDate() - 1);
                            const yesterdayStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;
                            if (!activeDates.has(yesterdayStr)) {
                                break; // No streak
                            }
                            // If yesterday has activity, we start streak from yesterday
                        } else if (activeDates.has(dateStr)) {
                            calculatedStreak++;
                            checkDate.setDate(checkDate.getDate() - 1);
                        } else {
                            break; // Streak broken
                        }
                    }

                    streakEl.textContent = `${calculatedStreak} Day${calculatedStreak !== 1 ? 's' : ''}`;

                    // Save it for reference if needed elsewhere
                    localStorage.setItem('dailyStreakCount', calculatedStreak.toString());

                    let currentCalDate = new Date(); // Start with current month

                    function renderCalendar(dateObj) {
                        const container = document.getElementById('streakCalendarContainer');
                        if (!container) return;

                        const year = dateObj.getFullYear();
                        const month = dateObj.getMonth();

                        const firstDay = new Date(year, month, 1).getDay();
                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                        const todayDateStr = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(new Date().getDate()).padStart(2, '0')}`;

                        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

                        let html = `
                            <div class="calendar-nav">
                                <button class="cal-nav-btn" id="calPrevBtn">&lt;</button>
                                <span>${monthNames[month]} ${year}</span>
                                <button class="cal-nav-btn" id="calNextBtn">&gt;</button>
                            </div>
                            <div class="streak-calendar">
                                <div class="calendar-header-day">S</div>
                                <div class="calendar-header-day">M</div>
                                <div class="calendar-header-day">T</div>
                                <div class="calendar-header-day">W</div>
                                <div class="calendar-header-day">T</div>
                                <div class="calendar-header-day">F</div>
                                <div class="calendar-header-day">S</div>
                        `;

                        // Empty slots before 1st of month
                        for (let i = 0; i < firstDay; i++) {
                            html += `<div></div>`;
                        }

                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const isActive = activeDates.has(dateStr);
                            const hasTodos = todoDates.has(dateStr);
                            const isToday = (dateStr === todayDateStr);

                            let classes = 'calendar-day';
                            if (isActive) classes += ' active-day';
                            if (isToday) classes += ' today';
                            if (hasTodos) classes += ' has-todos';
                            if (dateStr === currentTodoDate) classes += ' selected-date'; // highlight selection

                            html += `<div class="${classes}" style="cursor: pointer;" onclick="selectTodoDate('${dateStr}')">${day}</div>`;
                        }

                        html += `</div>`;
                        container.innerHTML = html;

                        document.getElementById('calPrevBtn').addEventListener('click', () => {
                            currentCalDate.setMonth(currentCalDate.getMonth() - 1);
                            renderCalendar(currentCalDate);
                        });

                        document.getElementById('calNextBtn').addEventListener('click', () => {
                            // Don't allow navigating past current month if we don't want to, but it's fine
                            currentCalDate.setMonth(currentCalDate.getMonth() + 1);
                            renderCalendar(currentCalDate);
                        });
                    }

                    renderCalendar(currentCalDate);

                } catch (e) {
                    console.warn("Could not load calendar data", e);
                }
            }
            loadCalendar();

            // 3. Custom Exam Builder logic
            let availBkqs = [];
            let availSms = [];

            async function loadAvailableQuestions() {
                try {
                    await initDB();
                    availBkqs = (await getAllBookmarks()) || [];
                    availSms = (await getAllSillyMistakes()) || [];

                    document.getElementById('availBkq').textContent = `Avail: ${availBkqs.length}`;
                    document.getElementById('availSm').textContent = `Avail: ${availSms.length}`;

                    document.getElementById('customBkqInput').max = availBkqs.length;
                    document.getElementById('customSmInput').max = availSms.length;
                } catch (e) {
                    console.warn("Could not load custom exam sources", e);
                }
            }

            loadAvailableQuestions();

            document.getElementById('startCustomExamBtn').addEventListener('click', () => {
                const numBkq = Math.min(parseInt(document.getElementById('customBkqInput').value) || 0, availBkqs.length);
                const numSm = Math.min(parseInt(document.getElementById('customSmInput').value) || 0, availSms.length);

                if (numBkq === 0 && numSm === 0) {
                    alert("Please select at least 1 question to build a custom exam.");
                    return;
                }

                // Randomly sample and shuffle
                const shuffleArray = arr => arr.sort(() => 0.5 - Math.random());
                const selectedBkqs = shuffleArray([...availBkqs]).slice(0, numBkq);
                const selectedSms = shuffleArray([...availSms]).slice(0, numSm);

                // Combine and deduplicate (in case same question is in both)
                const allSelected = [...selectedBkqs, ...selectedSms];
                const uniqueQuestions = [];
                const hashes = new Set();

                allSelected.forEach(q => {
                    if (!hashes.has(q.questionHash)) {
                        hashes.add(q.questionHash);
                        uniqueQuestions.push(q);
                    }
                });

                // Shuffle final list
                shuffleArray(uniqueQuestions);

                const customExamData = {
                    title: `Custom Revision Exam (${uniqueQuestions.length} Qs)`,
                    duration: Math.max(10, Math.ceil(uniqueQuestions.length * 3)), // 3 mins per question avg
                    sections: [{
                        name: "Mixed Revision",
                        questions: uniqueQuestions.map((q, idx) => ({
                            id: idx + 1,
                            question: q.questionText,
                            type: q.type || 'single',
                            options: q.options || [],
                            correct_answer: q.correctAnswer,
                            marks: q.maxMarks || 1,
                            negative_marks: q.negativeMarks || 0,
                            explanation: q.explanation || ''
                        }))
                    }]
                };

                // Assign to global examData and initialize directly
                examData = customExamData;
                shuffleExamData();
                initializeQuestionStates();

                if (window.enterFullScreen) window.enterFullScreen();
                toggleHomeView(false);
                document.getElementById('examSection').style.display = 'flex';

                startExam();
            });
        }

        // Expose function to update streak when exam is submitted (called from exam_script.js or result_script.js if needed)
        // But better to update it right when the exam finishes and saves to DB. 
        // We can just rely on localStorage being updated from result_script.js
        window.addEventListener('storage', (e) => {
            if (e.key === 'dailyStreakCount') {
                const currentStreak = parseInt(e.newValue || '0');
                document.getElementById('streakCountDisplay').textContent = `${currentStreak} Day${currentStreak !== 1 ? 's' : ''}`;
            }
        });

        async function viewExam(examId) {
            const details = await getExamDetails(examId);
            const exam = allExams.find(e => e.id === examId); // Use cached data (fix #12)
            if (!exam || details.length === 0) return;

            // Build result data in the same format as live exam results
            const summary = {
                correct: exam.correct,
                incorrect: exam.incorrect,
                unanswered: exam.unanswered,
                totalMarks: exam.total_marks.toFixed(2),
                maxTotalMarks: exam.max_marks.toFixed(2),
                totalQuestions: exam.total_questions,
                timestamp: exam.date,
                title: exam.title
            };
            const detailsFormatted = details.map(d => ({
                questionId: d.question_id,
                questionText: d.question_text,
                userAnswer: d.user_answer,
                userAnswerDisplay: (function () {
                    if (d.type === 'nat' || d.type === 'numerical' || d.type === 'numeric') return d.user_answer || 'Not Attempted';
                    if (d.user_answer === null || d.user_answer === undefined || d.user_answer === '') return 'Not Attempted';
                    const arr = Array.isArray(d.user_answer) ? d.user_answer : [d.user_answer];
                    return arr.length > 0 ? arr.map(idx => (d.options && d.options[idx] !== undefined) ? d.options[idx] : idx).join(', ') : 'Not Attempted';
                })(),
                correctAnswer: d.correct_answer,
                correctAnswerDisplay: Array.isArray(d.correct_answer) ? d.correct_answer.join(', ') : d.correct_answer,
                status: d.status,
                options: d.options,
                type: d.type,
                explanation: d.explanation,
                timeSpent: d.time_spent,
                marksObtained: d.marks_obtained || 0,
                maxMarks: d.max_marks || 0,
                negativeMarks: d.negative_marks || 0,
                markedForReview: d.marked_for_review || false
            }));

            // Store and navigate ‚Äî mark as history view so result page won't re-save
            sessionStorage.setItem('gateExamResults', JSON.stringify({
                summary,
                details: detailsFormatted,
                fromHistory: true
            }));
            window.location.href = 'result.html';
        }

        async function deleteExamEntry(examId) {
            if (!confirm('Delete this exam from history?')) return;
            await deleteExam(examId);
            await loadHistory();
        }
    </script>

    <script src="js/dark_mode.js"></script>

    <!-- Floating Calculator Overlay -->
    <div id="calculatorOverlay" class="calculator-overlay" style="display: none;">
        <div class="calculator-header" id="calculatorHeader">
            <span class="calc-title">Scientific Calculator</span>
            <button class="calc-close-btn" id="closeCalculatorBtn">&times;</button>
        </div>
        <iframe src="Calculator/Calculator.html" class="calculator-iframe" id="calculatorIframe"></iframe>
    </div>

    <!-- Question Paper Modal -->
    <div id="questionPaperModal" class="question-paper-modal" style="display: none;">
        <div class="question-paper-container">
            <div class="question-paper-header">
                <h2>Question Paper</h2>
                <button class="qp-close-btn" id="closeQuestionPaperBtn">&times;</button>
            </div>
            <div class="question-paper-content" id="questionPaperContent">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Telegram Auto-Backup Settings Modal -->
    <div id="tgModal" class="submit-modal" style="display: none;">
        <div class="submit-modal-content" style="max-width: 450px; text-align: left;">
            <h2 style="color: #3b5998; margin-bottom: 15px; text-align: center;">‚öôÔ∏è Telegram Backup Settings</h2>
            <p style="font-size: 14px; color: #555; margin-bottom: 20px;">
                Enter your Bot Token and Chat ID below to enable automatic daily and post-exam backups to your
                private
                Telegram channel. Get these from <strong>@BotFather</strong>.
            </p>
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: var(--text-color);">Bot
                    Token:</label>
                <input type="text" id="tgBotTokenInput" placeholder="e.g. 123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"
                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-color); color: var(--text-color); font-family: monospace;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: var(--text-color);">Chat
                    ID:</label>
                <input type="text" id="tgChatIdInput" placeholder="e.g. -1001234567890"
                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-color); color: var(--text-color); font-family: monospace;">
            </div>
            <div class="submit-modal-btns" style="justify-content: flex-end; gap: 10px;">
                <button class="btn-cancel" onclick="closeTgSettings()">Cancel</button>
                <button class="btn-submit" onclick="saveTgSettings(event)">Save & Test</button>
            </div>
        </div>
    </div>
    <!-- Scroll to Top Button -->
    <button id="scrollToTopBtn" class="scroll-to-top" title="Go to top">
        &#8679;
    </button>
</body>

</html>